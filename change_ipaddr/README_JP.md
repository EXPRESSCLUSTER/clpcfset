# clpcfsetを使用したクラスタサーバIPアドレスの変更手順

## はじめに
CLUSTERPRO X 4.3 でクラスタ構成情報ファイルの生成コマンド(clpcfset)が使用可能になりました。  
本ガイドでは、この clpcfset コマンドを使用し、クラスタサーバのIPアドレス変更の自動化を目的としたスクリプトを紹介します。

### スクリプト構成
- 本スクリプトを使用するためには、以下のファイルが必要です。  
     - Windowsの場合
	     - clp_changeIP.ps1 (サーバIPアドレス自動化スクリプト)
         - clp_changeIP.ini (設定ファイル)
	 - Linuxの場合
	     - clp_changeIP.sh (サーバIPアドレス自動化スクリプト)
		 - clp_changeIP.ini (設定ファイル)

###  動作確認済OS
 - Windows Server 2019
 - Windows Server 2016
 - Red Hat Enterprise Linux 7.9

### 動作確認済 CLUSTERPRO version
 - CLUSTERPRO X 4.3 for Windows / Linux


## スクリプト使用方法
1. (Linuxの場合のみ) xmllint をインストールしてください。
1. サーバIPアドレス自動化スクリプト(clp_changeIP.{ps1|sh}), 設定ファイル(clp_changeIP.ini) を任意のディレクトリに格納してください。  
   なお、スクリプト と 設定ファイルは必ず **同一ディレクトリ**  に格納してください。
1. clp_changeIP.ini を編集してください。clp_changeIP.ini のパラメータは以下の通りです。  
また、clp_changeIP.iniの詳細な修正方法については後述していますのでご確認ください。

	```
		[interconnect1]
		CUR_IPADDR=      ★ 現在設定されているIPアドレス
		NEW_IPADDR=      ★ 新しく設定したいIPアドレス
		NEW_PREFIX=      ★ 新しく設定したいサブネットマスク
		NEW_DGW=         ★ 新しく設定したいデフォルトゲートウェイ (空白OK)
		MODE=            ★ ミラーディスクコネクトとして使用している場合は mdc  
		                    ハートビートとして使用している場合は lan を記載する
	```
1. clpstat または Cluster WebUI を使用して、クラスタが正常状態か確認してください。正常状態でない場合は、エラー箇所を取り除いてください。
1. スクリプトと設定ファイルを格納したディレクトリに移動してください。

1. スクリプトを管理者権限で実行してください。

1. スクリプトが正常に終了した場合、以下の動作を行ってください。
    - clp_changeIP.ini に設定した MODE に1つでも mdc と記載した場合
	     - 全サーバ手動で再起動を実施してください。
    - clp_changeIP.ini に設定した MODE が全て lan の場合
         - 必要な動作はありません。クラスタが変更されたIPアドレスで正常に動作しているか確認してください。

以上で、クラスタサーバのIPアドレス変更が完了しました。

### 注意制限事項
 - 本スクリプトでは、IPv4のみ変更可能です。IPv6は変更できません。
 - 本スクリプトが途中で失敗した場合、それまでに本スクリプトで修正した箇所は反映されたままとなります。  
   そのため、以前の状態に戻す場合は、お客様自身で修正いただく必要があります。
 - ハートビートの種別に ミラー通信専用 を選択している場合は、本スクリプトは使用できません。
 - DNSサーバやフローティングIPアドレスの設定については変更対象外です。  
 本スクリプトを使用して修正できるパラメータは以下のみです
     - IPアドレス
     - サブネットマスク
     - デフォルトゲートウェイ 
 - 複数のIPアドレスを一括して変更することも可能です。詳細は後述している iniファイルの修正方法 を参照してください。
 - 以下の条件の場合、スクリプトが正常に終了した場合でも、mdwが異常となる場合があります。その場合は クラスタシャットダウンを実施後、全サーバでOS再起動を実行してください。
     - ハートビートを2本用意し、mdcとlanが1つずつ設定している場合 かつ lan に設定されたIPアドレスのみを本スクリプトで修正した場合


### 参考 iniファイルの修正方法
  (例1) 192.168.1.90 を  192.168.1.96/24 (デフォルトゲートウェイなし) に変更する場合 (mdcとして使用)
```
	[interconnect1]
	CUR_IPADDR=192.168.1.90
	NEW_IPADDR=192.168.1.96
	NEW_PREFIX=24
	NEW_DGW=
	MODE=mdc
```

  (例2) 192.168.1.90 を  192.168.1.96/24 (デフォルトゲートウェイなし) に変更する場合 (ミラーディスクコネクトとして使用)
      かつ、192.168.0.90 を  192.168.0.96/24 (デフォルトゲートウェイ 192.168.0.1) に変更する場合 (ハートビートとして使用)
```
	[interconnect1]
	CUR_IPADDR=192.168.1.90
	NEW_IPADDR=192.168.1.96
	NEW_PREFIX=24
	NEW_DGW=
	MODE=mdc

	[interconnect2]
	CUR_IPADDR=192.168.0.90
	NEW_IPADDR=192.168.0.96
	NEW_PREFIX=24
	NEW_DGW=192.169.0.2
	MODE=lan
```

