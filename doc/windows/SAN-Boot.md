# SAN ブート構成で共有ディスク型クラスタを構築する

## 構成図
```
+---------+       +---------+
| server1 |       | server2 |
+-----+---+       +---+-----+
      |               |
      +-------+-------+
              |
+-------------+-------------+
| Storage                   |
|                           |
|  For server1              |
| +-----------------------+ |
| | Boot                  | |
| +-----------------------+ |
| | C: System Drive       | |
| +-----------------------+ |
|                           |
|  For server2              |
| +-----------------------+ |
| | Boot                  | |
| +-----------------------+ |
| | C: System Drive       | |
| +-----------------------+ |
|                           |
|  Shared Volume            |
| +-----------------------+ |
| | R: NP Resolution      | |
| +-----------------------+ |
| | S: Data               | |
| +-----------------------+ |
+---------------------------+
```
- C: システムドライブ
- R: Disk 方式のネットワークパーティション (NP) 解決リソース用のドライブ
- S: サーバ間で引き継ぐデータを保存するドライブ

## 注意事項
- サイレントインストールの場合、全てのサーバから共有ディスク上のファイルシステムにアクセス可能な状態で作業を進めることになります。そのため、共有ディスク上にはデータがない状態でのクラスタ構築をお勧めいたします。また、クラスタ構築完了後には、該当のドライブに対して、chkdsk を実行することをお勧めします。

## 構築手順
### CLUSTERPRO のインストール
#### GUI によるインストール
1. インストール & 設定ガイドに従い、CLUSTERPRO をインストールしてください。
   - [共有ディスクのフィルタリング設定] にて、該当の HBA に対してフィルタリング設定を行ってください。また、ブート領域および C: ドライブに対しては、除外設定を行ってください。除外設定を行わないと、OS が起動しなくなります。 

#### サイレントインストール
1. インストール & 設定ガイドに従い、CLUSTERPRO をインストールしてください。
1. インストール後、全てのサーバを再起動してください。

### 構成情報の作成
1. サンプルスクリプト (PowerShell) をクラスタサーバに保存してください。
   - Oracle Cloud Infrastructure
     - [Paravirtualized](https://github.com/EXPRESSCLUSTER/clpcfset/tree/main/sample/windows/sd/oci/virtio)
1. サンプルスクリプト内のパラメータを適宜変更してください。
   - ドライブ文字があるドライブの GUID の取得方法
     - 以下のコマンドを実行してください。
       ```bat
       clpdiskctrl get guid C:
       e5ed6e77-9bf5-4c2f-8e37-00cad39ab7c6
       ```
   - ドライブ文字がないドライブの GUID の取得方法     
     - 以下のコマンドを実行し、systemvolume が True となっているドライブが
       ```ps
       PS C:\Windows\system32> get-wmiobject -class win32_volume |ft -Property name,deviceid,bootvolume,systemvolume |out-string -width 4096
       
       name                                              deviceid                                          bootvolume systemvolume
       ----                                              --------                                          ---------- ------------
       C:\                                               \\?\Volume{e5ed6e77-9bf5-4c2f-8e37-00cad39ab7c6}\       True        False
       \\?\Volume{55edbb61-db75-49cc-9e3e-5c108aae6c04}\ \\?\Volume{55edbb61-db75-49cc-9e3e-5c108aae6c04}\      False         True
       ```
1. 管理者権限で PowerShell を起動し、サンプルスクリプトを実行してください。
1. 実行後、サンプルスクリプトと同ディレクトリ内に clp.conf ファイルが作成されていることを確認してください。

### 構成情報の適用
1. clp.conf ファイルがあるディレクトリにて、以下のコマンドを実行してください。
   ```bat
   clpcfctrl --push -w -x .
   ```
1. 構成情報反映後、全てのサーバの OS を再起動してください。
1. OS 再起動後、クラスタが正常に動作していることを Cluster WebUI または clpstat コマンドで確認してください。
1. サイレントインストールでインストールした場合、ディスクリソースに設定されているドライブ (E.g. S: ドライブ) に対して、chkdsk を実行してください。
