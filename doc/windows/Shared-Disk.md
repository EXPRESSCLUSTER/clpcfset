# 共有ディスク型クラスタを構築する
- SAN ブート構成の場合は、[こちら](SAN-Boot.md)を参照してください。

## 構成図
```
+---------------------+       +---------------------+
| sever1              |       | sever2              |
| +-----------------+ |       | +-----------------+ |
| | System          | |       | | System          | |
| +-----------------+ |       | +-----------------+ |
| | C: OS           | |       | | C: OS           | |
| +-----------------+ |       | +-----------------+ |
+-----------------+---+       +---+-----------------+
                  |               |
                  +-------+-------+
                          |
            +-------------+-------------+
            | Storage                   |
            | +-----------------------+ |
            | | R: NP Resolution      | |
            | +-----------------------+ |
            | | S: Data               | |
            | +-----------------------+ |
            | | T: Data               | |
            | +-----------------------+ |
            +---------------------------+
```
- C: OS 領域
- R: Disk 方式のネットワークパーティション (NP) 解決リソース用のドライブ
- S, T: サーバ間で引き継ぐデータを保存するドライブ

## 注意事項
- フィルタ設定は1台ずつ行ってください。フィルタ設定が終わるまでは、もう一方のサーバは停止した状態にしてください。両サーバとも起動した状態で作業を進めると、共有ディスク上のファイルシステムに影響を与える恐れがあります。

## 構築手順
### CLUSTERPRO のインストール
#### GUI によるインストール
1. インストール & 設定ガイドに従い、CLUSTERPRO をインストールしてください。
   - [共有ディスクのフィルタリング設定] にて、該当の HBA に対してフィルタリング設定を行ってください。

#### サイレントインストール
1. servr1 にて、インストール & 設定ガイドに従い、CLUSTERPRO をインストールしてください。
1. OS を再起動してください。
1. 以下のコマンドを実行し、共有ディスクが接続されている HBA に対してフィルタ設定を行ってください。
   - 実行例
     ```bat
     clpdiskctrl set filter R:
     ```
1. OS を再起動してください。
1. 上記手順を server2 で行ってください。

### ライセンスファイルの登録
1. サーバ再起動後、clplcnsc コマンドでライセンスを登録してください。

### 構成情報の作成
1. サンプルスクリプト (PowerShell) をクラスタサーバに保存してください。
   - [Azure](../../sample/windows/sd/azure)
1. サンプルスクリプト内のパラメータを適宜変更してください。
   - $HBAPORT, $DEVICEID, $INSTANCEID
     - フィルタリングを行いたいドライブが接続されている HBA の情報を設定してください。以下で取得可能です。
       - 実行例
         ```bat
         clpdiskctrl get hba R:
         ```
       - 実行結果 (Azure)
         ```
         1,VMBUS\{ba6163d9-04a1-4d29-b605-72e2ffb1dc7f},{f8b3781b-1e82-4818-a1c3-63d806ec15bb}
         ```
         - 1: $HBAPORT
         - VMBUS\{ba6163d9-04a1-4d29-b605-72e2ffb1dc7f}: $DEVICEID
         - {f8b3781b-1e82-4818-a1c3-63d806ec15bb}: $INSTANCEID
   - $NPGUID, $SD1GUID, $SD2GUID
     - 以下のコマンドを実行してください。
       - 実行例
         ```bat
         clpdiskctrl get guid R:
         ```
       - 実行結果
         ```
         a1f0d795-caa3-47a2-b911-598c7e38a2da
         ```
       - 共有ディスクの LUN が GPT でフォーマットされていることを前提としたスクリプトになっています。MBR でフォーマットした場合、NPGUID, SD1GUID, SD2GUID がそれぞれのサーバで異なります。
1. 管理者権限で PowerShell を起動し、サンプルスクリプトを実行してください。
1. 実行後、サンプルスクリプトと同ディレクトリ内に clp.conf ファイルが作成されていることを確認してください。

### 構成情報の適用
1. clp.conf ファイルがあるディレクトリにて、以下のコマンドを実行してください。
   ```bat
   clpcfctrl --push -w -x .
   ```
1. 構成情報反映後、全てのサーバの OS を再起動してください。
1. OS 再起動後、クラスタが正常に動作していることを Cluster WebUI または clpstat コマンドで確認してください。
