# clpcfsetを使用したクラスタサーバIPアドレスの変更手順

## はじめに
CLUSTERPRO X 4.3 でクラスタ構成情報ファイルの生成コマンド(clpcfset)が使用可能になりました。
本ガイドでは、この clpcfset コマンドを使用し、クラスタサーバのIPアドレス変更の自動化を目的としたスクリプトを紹介します。

### スクリプト構成
- 本スクリプトを使用するためには、以下のファイルが必要です。  
    - clp_changeIP.ps1 (サーバIPアドレス自動化スクリプト)
    - clp_changeIP.ini (設定ファイル)

###  動作確認済OS
 - Windows Server 2019
 - Windows Server 2016

### 動作確認済 CLUSTERPRO version
 - CLUSTERPRO X 4.3 for Windows


## スクリプト使用方法

1. clp_changeIP.ps1, clp_changeIP.ini を任意のディレクトリに格納してください。
   なお、iniファイル と ps1ファイルは同一ディレクトリに格納してください。
1. clp_changeIP.ini を編集してください。clp_changeIP.ini のパラメータは以下の通りです。 
また、clp_changeIP.iniの詳細な修正方法については後述していますのでご確認ください。

	```
		[interconnect1]
		CUR_IPADDR=      ★ 現在設定されているIPアドレス
		NEW_IPADDR=      ★ 新しく設定したいIPアドレス
		NEW_PREFIX=      ★ 新しく設定したいサブネットマスク
		NEW_DGW=         ★ 新しく設定したいデフォルトゲートウェイ (空白OK)
		MODE=            ★ mdcとして使用する場合は mdc そうでない場合(ハートビート)の場合は lan を記載する
	```
1. clpstat または Cluster WebUI を使用して、クラスタが正常状態か確認してください。正常状態でない場合は、エラー箇所を取り除いてください。
1. clp_changeIP.ps1, clp_changeIP.ini を格納したディレクトリに移動してください。

1. clp_changeIP.ps1 を管理者権限で実行してください。
    -  clp_changeIP.ini に設定した MODE に1つでも mdc と記載した場合、ユーザで全サーバ手動で再起動する  
   lan の場合は必要ない (自動でクラスタサービスの再起動が実施される)

以上で、クラスタサーバのIPアドレス変更が完了しました。

### 注意制限事項
 - Ipv4のみ対応本スクリプトで変更可能です。
 - スクリプトが途中で失敗した場合、それまでに修正した箇所については手動で修正いただく必要があります。
 - ハートビートの種別に ミラー通信専用 を選択している場合は、本スクリプトは使用できません。
 - DNSサーバやフローティングIPアドレスの設定については変更対象外です。  
 本スクリプトを使用して修正できるパラメータは以下のみです
    - IPアドレス
    - サブネットマスク
    - デフォルトゲートウェイ 
 - 複数のIPアドレスを一括して変更することも可能です。詳細は後述している iniファイルの修正方法 を参照してください。

### 参考 iniファイルの修正方法
  (例1) 192.168.1.90 を  192.168.1.96/24 (デフォルトゲートウェイなし) に変更する場合 (mdcとして使用)
```
	[interconnect1]
	CUR_IPADDR=192.168.1.90
	NEW_IPADDR=192.168.1.96
	NEW_PREFIX=24
	NEW_DGW=
	MODE=mdc
```
  (例2) 192.168.1.90 を  192.168.1.96/24 (デフォルトゲートウェイなし) に変更する場合 (mdcとして使用)
      かつ、192.168.0.90 を  192.168.0.96/24 (デフォルトゲートウェイ 192.168.0.1) に変更する場合 (mdcとして使用しない)
```
	[interconnect1]
	CUR_IPADDR=192.168.1.90
	NEW_IPADDR=192.168.1.96
	NEW_PREFIX=24
	NEW_DGW=
	MODE=mdc

	[interconnect2]
	CUR_IPADDR=192.168.0.90
	NEW_IPADDR=192.168.0.96
	NEW_PREFIX=24
	NEW_DGW=192.169.0.2
	MODE=lan
```

